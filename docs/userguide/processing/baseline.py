# -*- coding: utf-8 -*-
# ---
# jupyter:
#   jupytext:
#     formats: ipynb,py:percent
#     notebook_metadata_filter: all
#     text_representation:
#       extension: .py
#       format_name: percent
#       format_version: '1.3'
#       jupytext_version: 1.13.6
#   kernelspec:
#     display_name: Python 3 (ipykernel)
#     language: python
#     name: python3
#   language_info:
#     codemirror_mode:
#       name: ipython
#       version: 3
#     file_extension: .py
#     mimetype: text/x-python
#     name: python
#     nbconvert_exporter: python
#     pygments_lexer: ipython3
#     version: 3.9.10
#   widgets:
#     application/vnd.jupyter.widget-state+json:
#       state:
#         04d8d74a509c4a098fcb5c5a4126716a:
#           model_module: '@jupyter-widgets/controls'
#           model_module_version: 1.5.0
#           model_name: ButtonStyleModel
#           state: {}
#         0b7c6e31c06f4ef1872be8b4e57adfb5:
#           model_module: '@jupyter-widgets/base'
#           model_module_version: 1.2.0
#           model_name: LayoutModel
#           state: {}
#         0f200072e3dd4bac8a520e74e9029d36:
#           model_module: '@jupyter-widgets/controls'
#           model_module_version: 1.5.0
#           model_name: ButtonModel
#           state:
#             description: process
#             icon: play
#             layout: IPY_MODEL_274df4902dda46dcb5ecd8257f1d5817
#             style: IPY_MODEL_afb587e9ec3d4b32ae0cccee7311549a
#         104d8a6dc3e14122894362110d3c8a4e:
#           model_module: '@jupyter-widgets/controls'
#           model_module_version: 1.5.0
#           model_name: DescriptionStyleModel
#           state:
#             description_width: ''
#         1294902554294b4495491fea12fcff1e:
#           model_module: '@jupyter-widgets/base'
#           model_module_version: 1.2.0
#           model_name: LayoutModel
#           state: {}
#         134e3926b5b14b478064cab0e568b9a9:
#           model_module: '@jupyter-widgets/controls'
#           model_module_version: 1.5.0
#           model_name: DescriptionStyleModel
#           state:
#             description_width: ''
#         1bddf15dada6490caff65ecfc83e59a0:
#           model_module: '@jupyter-widgets/base'
#           model_module_version: 1.2.0
#           model_name: LayoutModel
#           state: {}
#         1e36fa8003d1485cae8905f57b96aab1:
#           model_module: '@jupyter-widgets/controls'
#           model_module_version: 1.5.0
#           model_name: DescriptionStyleModel
#           state:
#             description_width: ''
#         240a44519c6f45f896f6e6383bba7d05:
#           model_module: '@jupyter-widgets/base'
#           model_module_version: 1.2.0
#           model_name: LayoutModel
#           state: {}
#         274df4902dda46dcb5ecd8257f1d5817:
#           model_module: '@jupyter-widgets/base'
#           model_module_version: 1.2.0
#           model_name: LayoutModel
#           state: {}
#         275574254e7e454087feb126ac55eebd:
#           model_module: '@jupyter-widgets/controls'
#           model_module_version: 1.5.0
#           model_name: HBoxModel
#           state:
#             children:
#             - IPY_MODEL_2ae394614b80417d8d8eaf986baf00e0
#             layout: IPY_MODEL_e023e7ac88864eb2b0e261f1f5b7c3c0
#         29f03307f78f41a5ab89e87f64a7d21f:
#           model_module: '@jupyter-widgets/base'
#           model_module_version: 1.2.0
#           model_name: LayoutModel
#           state: {}
#         2ae394614b80417d8d8eaf986baf00e0:
#           model_module: '@jupyter-widgets/controls'
#           model_module_version: 1.5.0
#           model_name: DropdownModel
#           state:
#             _options_labels:
#             - sequential
#             - multivariate
#             description: Method
#             index: 0
#             layout: IPY_MODEL_8ccb60469f5747b6b85824b0d09c2e54
#             style: IPY_MODEL_104d8a6dc3e14122894362110d3c8a4e
#         2bd70835f3ee4ea1b3e66815a1ea3948:
#           model_module: '@jupyter-widgets/base'
#           model_module_version: 1.2.0
#           model_name: LayoutModel
#           state: {}
#         30ce7afed95c4c66844f5ce9f9b3baeb:
#           model_module: '@jupyter-widgets/base'
#           model_module_version: 1.2.0
#           model_name: LayoutModel
#           state: {}
#         3baff223afd44063899f26324ec0ae67:
#           model_module: '@jupyter-widgets/controls'
#           model_module_version: 1.5.0
#           model_name: DropdownModel
#           state:
#             _options_labels:
#             - polynomial
#             - pchip
#             description: Interpolation
#             index: 0
#             layout: IPY_MODEL_29f03307f78f41a5ab89e87f64a7d21f
#             style: IPY_MODEL_134e3926b5b14b478064cab0e568b9a9
#         4050201ef8ab4b19944de1bdf4caa295:
#           model_module: '@jupyter-widgets/base'
#           model_module_version: 1.2.0
#           model_name: LayoutModel
#           state: {}
#         51c845cffd134bfcbaaf6914366810c5:
#           model_module: '@jupyter-widgets/controls'
#           model_module_version: 1.5.0
#           model_name: SliderStyleModel
#           state:
#             description_width: ''
#         5321047bc60944499e508f744b494e8a:
#           model_module: '@jupyter-widgets/controls'
#           model_module_version: 1.5.0
#           model_name: ButtonModel
#           state:
#             description: save as
#             icon: save
#             layout: IPY_MODEL_c8e63d5d15884e91a2b5c41fe86d7f26
#             style: IPY_MODEL_04d8d74a509c4a098fcb5c5a4126716a
#         57de80008bfc45a7a5b918a355fefd90:
#           model_module: '@jupyter-widgets/controls'
#           model_module_version: 1.5.0
#           model_name: VBoxModel
#           state:
#             children:
#             - IPY_MODEL_7c511d3f48854e66a8be445ea606d319
#             - IPY_MODEL_0f200072e3dd4bac8a520e74e9029d36
#             - IPY_MODEL_5321047bc60944499e508f744b494e8a
#             layout: IPY_MODEL_acf5cdc35f8c4506ab864453d96ca59d
#         6777aa400a1c4f97b0a0130b858e5989:
#           model_module: '@jupyter-widgets/controls'
#           model_module_version: 1.5.0
#           model_name: HBoxModel
#           state:
#             children:
#             - IPY_MODEL_57de80008bfc45a7a5b918a355fefd90
#             - IPY_MODEL_a71c8356fd194ee8917dc2601c61ee91
#             layout: IPY_MODEL_240a44519c6f45f896f6e6383bba7d05
#         7c511d3f48854e66a8be445ea606d319:
#           model_module: '@jupyter-widgets/controls'
#           model_module_version: 1.5.0
#           model_name: FileUploadModel
#           state:
#             description: upload
#             description_tooltip: null
#             disabled: true
#             layout: IPY_MODEL_a3d0d3a1d4004582951ba07007fb86a8
#             multiple: true
#             style: IPY_MODEL_ab9ee9fb36264adca14dd228dc6fb48e
#         88fd58c2424b44da8d730f24b6fc4f7e:
#           model_module: '@jupyter-widgets/controls'
#           model_module_version: 1.5.0
#           model_name: TextModel
#           state:
#             description: 'x slice:'
#             layout: IPY_MODEL_30ce7afed95c4c66844f5ce9f9b3baeb
#             style: IPY_MODEL_fa9cf95ed0054f6e9f273867b5f86f63
#             value: '[5999.56 : 649.9 : 1]'
#         8ccb60469f5747b6b85824b0d09c2e54:
#           model_module: '@jupyter-widgets/base'
#           model_module_version: 1.2.0
#           model_name: LayoutModel
#           state: {}
#         953911227c8147f3990bbcf3e156293b:
#           model_module: '@jupyter-widgets/controls'
#           model_module_version: 1.5.0
#           model_name: HBoxModel
#           state:
#             children:
#             - IPY_MODEL_3baff223afd44063899f26324ec0ae67
#             - IPY_MODEL_a2772063115a435a9499e08c304192a3
#             layout: IPY_MODEL_99688e54c6df4e0298770edc4e8a26fe
#         96bf9d6f2f9548fd81c1830512d1a0d5:
#           model_module: '@jupyter-widgets/controls'
#           model_module_version: 1.5.0
#           model_name: IntSliderModel
#           state:
#             description: npc
#             layout: IPY_MODEL_1bddf15dada6490caff65ecfc83e59a0
#             max: 5
#             min: 1
#             style: IPY_MODEL_aead51f40c7340b8ba52e4a8b9c50244
#             value: 1
#         99688e54c6df4e0298770edc4e8a26fe:
#           model_module: '@jupyter-widgets/base'
#           model_module_version: 1.2.0
#           model_name: LayoutModel
#           state: {}
#         9a4821963a674978b88a4c6801679e0c:
#           model_module: '@jupyter-widgets/output'
#           model_module_version: 1.0.0
#           model_name: OutputModel
#           state:
#             layout: IPY_MODEL_0b7c6e31c06f4ef1872be8b4e57adfb5
#         a2772063115a435a9499e08c304192a3:
#           model_module: '@jupyter-widgets/controls'
#           model_module_version: 1.5.0
#           model_name: IntSliderModel
#           state:
#             description: orderslider
#             layout: IPY_MODEL_2bd70835f3ee4ea1b3e66815a1ea3948
#             max: 6
#             min: 1
#             style: IPY_MODEL_51c845cffd134bfcbaaf6914366810c5
#             value: 2
#         a3d0d3a1d4004582951ba07007fb86a8:
#           model_module: '@jupyter-widgets/base'
#           model_module_version: 1.2.0
#           model_name: LayoutModel
#           state: {}
#         a71c8356fd194ee8917dc2601c61ee91:
#           model_module: '@jupyter-widgets/controls'
#           model_module_version: 1.5.0
#           model_name: VBoxModel
#           state:
#             children:
#             - IPY_MODEL_cff38341164d4da9b67453824f6e5780
#             - IPY_MODEL_275574254e7e454087feb126ac55eebd
#             - IPY_MODEL_953911227c8147f3990bbcf3e156293b
#             - IPY_MODEL_c6aada1a10e3434798cc44ff0a2320b2
#             layout: IPY_MODEL_e4dab3d6dee54651b52ec89b943e5bb0
#         ab9ee9fb36264adca14dd228dc6fb48e:
#           model_module: '@jupyter-widgets/controls'
#           model_module_version: 1.5.0
#           model_name: ButtonStyleModel
#           state: {}
#         acf5cdc35f8c4506ab864453d96ca59d:
#           model_module: '@jupyter-widgets/base'
#           model_module_version: 1.2.0
#           model_name: LayoutModel
#           state: {}
#         aead51f40c7340b8ba52e4a8b9c50244:
#           model_module: '@jupyter-widgets/controls'
#           model_module_version: 1.5.0
#           model_name: SliderStyleModel
#           state:
#             description_width: ''
#         afb587e9ec3d4b32ae0cccee7311549a:
#           model_module: '@jupyter-widgets/controls'
#           model_module_version: 1.5.0
#           model_name: ButtonStyleModel
#           state: {}
#         c6aada1a10e3434798cc44ff0a2320b2:
#           model_module: '@jupyter-widgets/controls'
#           model_module_version: 1.5.0
#           model_name: TextareaModel
#           state:
#             description: 'Ranges:'
#             layout: IPY_MODEL_1294902554294b4495491fea12fcff1e
#             style: IPY_MODEL_1e36fa8003d1485cae8905f57b96aab1
#             value: '(
#
#               [5999.56, 5465.36],
#
#               [1183.13, 649.9]
#
#               )'
#         c7e3c35380854f75b11772e71f9a4b75:
#           model_module: '@jupyter-widgets/controls'
#           model_module_version: 1.5.0
#           model_name: DescriptionStyleModel
#           state:
#             description_width: ''
#         c8e63d5d15884e91a2b5c41fe86d7f26:
#           model_module: '@jupyter-widgets/base'
#           model_module_version: 1.2.0
#           model_name: LayoutModel
#           state: {}
#         c912d4a02bcc4f57b56caa686a729650:
#           model_module: '@jupyter-widgets/controls'
#           model_module_version: 1.5.0
#           model_name: TextModel
#           state:
#             description: 'y slice:'
#             layout: IPY_MODEL_fbb008a744de47d281dd61c7cfd39485
#             style: IPY_MODEL_c7e3c35380854f75b11772e71f9a4b75
#             value: '[0 : 55 : 1]'
#         cff38341164d4da9b67453824f6e5780:
#           model_module: '@jupyter-widgets/controls'
#           model_module_version: 1.5.0
#           model_name: HBoxModel
#           state:
#             children:
#             - IPY_MODEL_88fd58c2424b44da8d730f24b6fc4f7e
#             - IPY_MODEL_c912d4a02bcc4f57b56caa686a729650
#             layout: IPY_MODEL_4050201ef8ab4b19944de1bdf4caa295
#         e023e7ac88864eb2b0e261f1f5b7c3c0:
#           model_module: '@jupyter-widgets/base'
#           model_module_version: 1.2.0
#           model_name: LayoutModel
#           state: {}
#         e4dab3d6dee54651b52ec89b943e5bb0:
#           model_module: '@jupyter-widgets/base'
#           model_module_version: 1.2.0
#           model_name: LayoutModel
#           state: {}
#         fa9cf95ed0054f6e9f273867b5f86f63:
#           model_module: '@jupyter-widgets/controls'
#           model_module_version: 1.5.0
#           model_name: DescriptionStyleModel
#           state:
#             description_width: ''
#         fbb008a744de47d281dd61c7cfd39485:
#           model_module: '@jupyter-widgets/base'
#           model_module_version: 1.2.0
#           model_name: LayoutModel
#           state: {}
#       version_major: 2
#       version_minor: 0
# ---

# %% [markdown]
# # Baseline corrections
#
# This tutorial shows how to make baseline corrections with spectrochempy.
# As prerequisite, the user is expected to have read the [Import](../importexport/import.ipynb)
# and [Import IR](../importexport/importIR.ipynb) tutorials.

# %%
import spectrochempy as scp

# %% [markdown]
# Now let's import and plot a typical IR dataset which wase recorded during the removal of ammonia from a NH4-Y
# zeolite:

# %%
X = scp.read_omnic("irdata/nh4y-activation.spg")
X[:, 1290.0:890.0] = scp.MASKED

# %% [markdown]
# After setting some plotting preferences and plot it

# %%
prefs = X.preferences
prefs.figure.figsize = (7, 3)
prefs.colormap = "magma"
_ = X.plot()

# %% [markdown]
# ## Background subtraction
#
# Often, particularly for surface species, the baseline is first corrected by subtracting a reference spectrum. In this
# example, it could be, for instance, the last spectrum (index -1). Hence:

# %%
Xdiff = X - X[-1]
_ = Xdiff.plot()

# %% [markdown]
# ## Detrend
#
# Other simple baseline corrections - often use in preprocessing prior chemometric analysis - constist in shifting
# the spectra or removing a linear trend. This is done using the detrend() method, which is a wrapper of the [
# detrend() method](https://docs.scipy.org/doc/scipy/reference/generated/scipy.signal.detrend.html) from the [
# scipy.signal](https://docs.scipy.org/doc/scipy/reference/signal.html) module to which we refer the interested reader.

# %% [markdown]
# ### Linear trend
# Subtract the linear trend of each spectrum (type='linear', default)

# %%
_ = X.detrend().plot()

# %% [markdown]
# ### Constant trend
# Subtract the average absorbance to each spectrum

# %%
_ = X.detrend(type="constant").plot()

# %% [markdown]
# ## Automatic linear baseline correction `abc`

# %% [markdown]
# When the baseline to remove is a simple linear correction, one can use ``abc``.
# This performs an automatic baseline correction.

# %%
_ = scp.abc(X).plot()

# %% [markdown]
# ## Advanced baseline correction
#
# 'Advanced' baseline correction basically consists for the user to choose:
#
# - spectral ranges which s/he considers as belonging to the baseline - the type of polynomial(s) used to model the
# baseline in and between these regions (keyword: `interpolation`) - the method used to apply the correction to
# spectra: sequentially to each spectrum, or using a multivariate approach (keyword: `method`).
#
# ### Range selection
#
# Each spectral range is defined by a list of two values indicating the limits of the spectral ranges, e.g. `[4500.,
# 3500.]` to
# select the 4500-3500 cm$^{-1}$ range. Note that the ordering has no importance and using `[3500.0, 4500.]` would
# lead to exactly the same result. It is also possible to formally pick a single wavenumber `3750.`.
#
# The first step is then to select the various regions that we expect to belong to the baseline

# %%
ranges = [5900.0, 5400.0], 4550.0, [4500.0, 4000.0], [2100.0, 2000.0], [1550.0, 1555.0]

# %% [markdown]
# After selection of the baseline ranges, the baseline correction can be made using a sequence of 2 commands:
#
# 1. Initialize an instance of BaselineCorrection

# %%
blc = scp.BaselineCorrection(X)

# %% [markdown]
# 2. compute baseline other the ranges

# %%
Xcorr = blc.compute(ranges)
Xcorr

# %% [markdown]
# * plot the result (blc.corrected.plot() would lead to the same result)

# %%
_ = Xcorr.plot()

# %% [markdown]
# ### Interpolation method
#
#
# The previous correction was made using the default parameters for the interpolation ,i.e. an interpolation using
# cubic Hermite spline interpolation: `interpolation='pchip'` (`pchip` stands for **P**iecewise **C**ubic **H**ermite
# **I**nterpolating **P**olynomial). This option triggers the use of [scipy.interpolate.PchipInterpolator()](
# https://docs.scipy.org/doc/scipy/reference/generated/scipy.interpolate.PchipInterpolator.html) to which we refer
# the interested readers. The other interpolation method is the classical polynomial interpolation
# (`interpolation='polynomial'`) in which case the order can also be set (e.g. `order=3`, the default value being 6).
# In this case, the base methods used for the interpolation are those of the [polynomial module](
# https://numpy.org/doc/stable/reference/routines.polynomials.polynomial.html) of spectrochempy, in particular the
# [polyfit()](https://numpy.org/doc/stable/reference/generated/numpy.polynomial.polynomial.polyfit.html#numpy
# .polynomial.polynomial.polyfit) method.
#
# For instance:

# %% [markdown]
# First, we put the ranges in a list

# %%
ranges = [[5900.0, 5400.0], [4000.0, 4500.0], [2100.0, 2000.0], [1550.0, 1555.0]]

# %% [markdown]
# <div class='alert alert-warning'>
# <b>Warning</b>
#
# if you use a tuple to define the sequences of ranges:
#
# ```ipython3
# ranges = [5900.0, 5400.0], [4000., 4500.], [2100., 2000.0], [1550., 1555.]
# ```
#
# or
#
# ```ipython3
# ranges = ([5900.0, 5400.0], [4000., 4500.], [2100., 2000.0], [1550., 1555.])
# ```
#
# then you can call `compute` by directly pass the ranges tuple, or you can unpack it as below.
#
# ```ipython3
# blc.compute(ranges, ....)
# ```
#
#
# if you use a list instead of tuples:
#
# ```ipython3
# ranges = [[5900.0, 5400.0], [4000., 4500.], [2100., 2000.0], [1550., 1555.]]
# ```
#
# then you **MUST UNPACK** the element when calling `compute`:
#
# ```ipython3
# blc.compute(*ranges, ....)
# ```
#
#
# </div>

# %%
blc = scp.BaselineCorrection(X)
blc.compute(*ranges, interpolation="polynomial", order=6)

# %% [markdown]
# The `corrected` attribute contains the corrected NDDataset.

# %%
_ = blc.corrected.plot()

# %% [markdown]
# ### Multivariate method
#
# The `method` option defines whether the selected baseline regions of the spectra should be taken 'as is'
# this is the default `method='sequential'`), or modeled using a multivariate approach (`method='multivariate'`).
#
# The `'multivariate'` option is useful when the signal‐to‐noise ratio is low and/or when the baseline changes in
# various regions of the spectrum are correlated. It consist in (i) modeling the baseline regions by a principal
# component analysis (PCA), (ii) interpolate the loadings of the first principal components over the whole spectral
# and (iii) modeling the spectra baselines from the product of the PCA scores and the interpolated loadings.
# (for detail: see [Vilmin et al. Analytica Chimica Acta 891 (2015)](http://dx.doi.org/10.1016/j.aca.2015.06.006)).
#
# If this option is selected, the user should also choose `npc`, the number of principal components used to model the
# baseline. In a sense, this parameter has the same role as the `order` parameter, except that it will affect how well
# the baseline fits the selected regions, but on *both dimensions: wavelength and acquisition time*. In particular a
# large value of `npc` will lead to overfit of baseline variation with time and will lead to the same result as the
# `sequential` method while a too small `value` would miss important principal component underlying the baseline change
# over time. Typical optimum values are `npc=2` or `npc=3` (see Exercises below).

# %%
blc = scp.BaselineCorrection(X)
blc.compute(*ranges, interpolation="pchip", method="multivariate", npc=2)
_ = blc.corrected.plot()

# %% [markdown]
# ### Code snippet for 'advanced' baseline correction
# The following code in which the user can change any of the parameters and look at the changes after re-running
# the cell:

# %%
# user defined parameters
# -----------------------
ranges = (
    [5900.0, 5400.0],
    [4000.0, 4500.0],
    4550.0,
    [2100.0, 2000.0],
    [1550.0, 1555.0],
    [1250.0, 1300.0],
    [800.0, 850.0],
)
interpolation = "pchip"  # choose 'polynomial' or 'pchip'
order = 5  # only used for 'polynomial'
method = "sequential"  # choose 'sequential' or 'multivariate'
npc = 3  # only used for 'multivariate'

# code: compute baseline, plot original and corrected NDDatasets and ranges
# -------------------------------------------------------------------------
blc = scp.BaselineCorrection(X)
Xcorr = blc.compute(
    *ranges, interpolation=interpolation, order=order, method=method, npc=npc
)

axes = scp.multiplot(
    [X, Xcorr],
    labels=["Original", "Baseline corrected"],
    sharex=True,
    nrow=2,
    ncol=1,
    figsize=(7, 6),
    dpi=96,
)
blc.show_regions(axes["axe21"])

# %% [markdown]
# ### Widget for "advanced" baseline corrections
# The `BaselineCorrector()` widget can be used in jupyter notebook (not jupyter lab).
# - The buttons are as follows:
#   - `upload`: upload files (disabled if a NDDataset is passed as parameter). Uploading file will not trigger the reading
# and processing. To do so, the user is expected to click the `process` button.
#   - `process`: baseline correct and plot original dataset + baseline and  corrected datasets
#   - `save as`: save the baseline corrected NDDataset
# - The `x slice` anbd `y slice` textboxes can be used to slice the initial dataset with the usual `[start:stop:step]`
# format. In the `x` dimension, coordinates or indexes can be used (e.g. `[3000.0:2000.0:1]` or `[0:100:1]` are valid
# entries). In the `y` dimension only indexes can be used (e.g. `[0:10:1]`). Note also that currently none of the
# `start`, `stop`, `step` parameters can be omitted, e.g. `[3000.0:2000.0]` or `[:,:]` are not valid entries.
# - Method and Interpolation are self-explaining, see above for details
# - Ranges should be entered as a tuple of numerals or wavenumbers, e.g.
#     (
#     [5900.0, 5400.0],
#     2000.0,
#     [1550.0, 1555.0],)
#

# %%
X = scp.read_omnic("irdata/nh4y-activation.spg")
out = scp.BaselineCorrector(X)

# %% [markdown]
# After processing, one can get the original (sliced) dataset, corrected dataset and baselines
# through the following attributes:

# %% [markdown]
# <div class='alert alert-info'>
#     <b>Exercises</b>
#
# **basic:**
# - write commands to subtract (i) the first spectrum from a dataset and (ii) the mean spectrum from a dataset
# - write a code to correct the baseline of the last 10 spectra of the above dataset in the 4000-3500 cm$^{-1}$ range
#
# **intermediate:**
# - what would be the parameters to use in 'advanced' baseline correction to mimic 'detrend' ? Write a code to check
# your answer.
#
# **advanced:**
# - simulate noisy spectra with baseline drifts and compare the performances of `multivariate` vs `sequential` methods
# </div>
